# tmux configuration
# Requires: tmux 3.2+ (tested with 3.5a)
#
# TPM (tmux Plugin Manager) Commands:
#   prefix + I       Install plugins
#   prefix + U       Update plugins
#   prefix + alt-u   Uninstall removed plugins

# ==============================================================================
# General Settings
# ==============================================================================

# Use fish shell (fallback to zsh if not available)
if-shell '[ -x /opt/homebrew/bin/fish ]' {
    set -g default-shell /opt/homebrew/bin/fish
} {
    if-shell '[ -x /usr/local/bin/fish ]' {
        set -g default-shell /usr/local/bin/fish
    } {
        set -g default-shell /bin/zsh
    }
}

# Terminal settings for true color support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc,xterm-kitty:Tc"
set -sa terminal-features ",xterm-256color:RGB,xterm-kitty:RGB"

# General behavior
set -g base-index 1              # Start window numbering at 1
set -g pane-base-index 1         # Start pane numbering at 1
set -g renumber-windows on       # Renumber windows when one is closed
set -s escape-time 0             # No delay for escape key
set -g history-limit 10000       # Scrollback buffer size
set -g display-time 2000         # Message display time (ms)
set -g focus-events on           # Pass focus events to applications
set -g mouse on                  # Enable mouse support
set -g detach-on-destroy off     # Don't exit tmux when last session closes
set -g mode-keys vi              # Vi keys in copy mode

# Activity monitoring
set -g monitor-activity on
set -g visual-activity on

# ==============================================================================
# Key Bindings
# ==============================================================================

# Reload config
bind r source-file ~/.tmux.conf \; display-message "Config reloaded"

# Window splitting (preserve current path)
bind v split-window -h -c "#{pane_current_path}"
bind b split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Arrow key window navigation
bind Left previous-window
bind Right next-window
bind Up choose-buffer
bind Down choose-buffer

# Vi copy mode bindings
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel

# Mouse toggle
bind m set -g mouse \; display "Mouse: #{?mouse,ON,OFF}"

# Function keys (no prefix required)
bind -n F1 clock-mode
bind -n F3 previous-window
bind -n F4 next-window
bind -n F5 choose-buffer

# TMS (tmux-sessionizer) bindings
bind -r '(' switch-client -p \; refresh-client -S
bind -r ')' switch-client -n \; refresh-client -S
bind C-o display-popup -E "tms"
bind C-j display-popup -E "tms switch"
bind C-w command-prompt -p "Rename session: " "run-shell 'tms rename %1'"
bind C-r display-message "Refreshing TMS..." \; run-shell 'tms refresh' \; display-message "TMS refreshed"

# ==============================================================================
# Status Bar
# ==============================================================================

set -g status on
set -g status-interval 1
set -g status-justify left
set -g status-left-length 50
set -g status-right-length 140

# Status bar style (transparent background)
set -g status-style "bg=default,fg=colour231"

# Window status
setw -g window-status-current-style "fg=default,bg=default"
setw -g window-status-current-format "#[fg=colour106,bright] ⎨ #[fg=colour154,bright]#I:#W #[fg=colour106]⎬ "

# Status left: prefix indicator + session name
set -g status-left "#{prefix_highlight}"
set -ga status-left " #[fg=colour202,bright]#S"
set -ga status-left " #[fg=colour214]❯❯❯ "

# Status right: uptime / date / time / battery
set -g status-right "#[fg=colour201,bright]↑#[fg=colour207,dim]#(uptime | cut -f 4-5 -d ' ' | cut -f 1 -d ',')"
set -ga status-right " #[fg=colour81]/ "
set -ga status-right "#[fg=colour225]%a #[fg=colour219]%m/%d"
set -ga status-right " #[fg=colour81]/ "
set -ga status-right "#[fg=colour156]%H:%M "
set -ga status-right "#{battery_color_charge_fg}#{battery_icon_charge}#{battery_color_status_fg} #{battery_remain} "

# Pane/window styles
set -g window-style "fg=default,bg=colour16"
set -g window-active-style "fg=default,bg=default"

# ==============================================================================
# Plugin Settings
# ==============================================================================

# Prefix highlight
set -g @prefix_highlight_fg colour231
set -g @prefix_highlight_bg colour202
set -g @prefix_highlight_empty_prompt '    '

# Battery (color tiers from green to red)
set -g @batt_remain_short true
set -g @batt_color_charge_primary_tier8 colour34
set -g @batt_color_charge_primary_tier7 colour118
set -g @batt_color_charge_primary_tier6 colour190
set -g @batt_color_charge_primary_tier5 colour220
set -g @batt_color_charge_primary_tier4 colour214
set -g @batt_color_charge_primary_tier3 colour208
set -g @batt_color_charge_primary_tier2 colour202
set -g @batt_color_charge_primary_tier1 colour196
set -g @batt_color_charge_secondary_tier8 colour237
set -g @batt_color_charge_secondary_tier7 colour237
set -g @batt_color_charge_secondary_tier6 colour237
set -g @batt_color_charge_secondary_tier5 colour237
set -g @batt_color_charge_secondary_tier4 colour237
set -g @batt_color_charge_secondary_tier3 colour237
set -g @batt_color_charge_secondary_tier2 colour237
set -g @batt_color_charge_secondary_tier1 colour237
set -g @batt_color_status_primary_charged colour22
set -g @batt_color_status_primary_charging colour136
set -g @batt_color_status_primary_discharging colour99
set -g @batt_color_status_primary_attached colour17
set -g @batt_color_status_primary_unknown colour240
set -g @batt_color_status_secondary_charged colour34
set -g @batt_color_status_secondary_charging colour220
set -g @batt_color_status_secondary_discharging colour177
set -g @batt_color_status_secondary_attached colour45
set -g @batt_color_status_secondary_unknown colour237

# ==============================================================================
# Plugins (TPM)
# ==============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-logging'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'thewtex/tmux-mem-cpu-load'
set -g @plugin 'sainnhe/tmux-fzf'

# Initialize TPM (must be at the very end)
run -b '~/.tmux/plugins/tpm/tpm'
